<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><script data-ad-client="ca-pub-9442633619132398" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script data-ad-client="ca-pub-9442633619132398" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="Sodino的个人博客"><title>【C/C++】内存分配与释放(malloc、calloc、realloc、free) | Sodino's Blog</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/7.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">【C/C++】内存分配与释放(malloc、calloc、realloc、free)</h1><a id="logo" href="/.">Sodino's Blog</a><p class="description">见多食广 与食巨近</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> RSS</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">【C/C++】内存分配与释放(malloc、calloc、realloc、free)</h1><div class="post-meta">Mar 22, 2015<span> | </span><span class="category"><a href="/categories/C-C/">C/C++</a></span></div><div class="post-content"><p>本文结构</p>
<ul>
<li><a href="#area">内存区域</a></li>
<li><a href="#func">函数讲解</a></li>
<li><a href="#mem_leak">realloc的内存泄露陷井</a></li>
<li><a href="#demo">示例代码</a></li>
</ul>
<hr>
<h1 id="内存区域"><a href="#内存区域" class="headerlink" title="内存区域"></a><a name="area">内存区域</a></h1><p>在程序的执行期间经常需要动态的分配内存。<br>具体表现有在函数体内声明了一个变量、结构体或数组等，这样的内存是分配是由系统操作分配在<strong>栈</strong>上的，在执行完函数后，函数体内开头所声明的变量、结构体或数组所持有的内存空间都会被释放。所以要将函数体内的执行结果返回或反映到函数体外，一般是行不通的(不考虑全局变量)。<br>还有一种是由coder们调用<code>malloc()</code>等内存分配函数在<strong>堆</strong>上开辟新内存块，这些内存块会一起存在直至调用<code>free()</code>函数去释放。作用域广了，但也引入了潜在的内存泄露(程序卡顿)和野指针(程序crash)问题。</p>
<hr>
<h1 id="函数讲解"><a href="#函数讲解" class="headerlink" title="函数讲解"></a><a name="func">函数讲解</a></h1><pre><code>#include &lt;stdlib.h&gt;

void *malloc(size_t size);
void *calloc(size_t nmemb, size_t size);
void *realloc(void *ptr, size_t size);

void free(void *ptr);</code></pre><p>引入<code>stdlib.h</code>头文件后可以在代码中操作内存的分配与释放。<br>下面来一一讲解下内存分配函数：</p>
<ul>
<li>void *malloc(size_t size);</li>
</ul>
<p><code>malloc()</code>函数分配了指定大小为<code>size</code>的字节数，这些字节块是没有被初始化的，也就是说有可能是非<code>\0</code>有值的。这也正是<code>malloc()</code>的缺点。如果<code>size</code>为0，则函数返回<code>NULL</code>；否则返回一个指向该内存块的指针，该指针可随后被<code>free()</code>调用释放。<br>函数的返回类型是<code>void *</code>，即任意类型，虽然很多编译器会把<code>malloc()</code>返回的地址自动转换成赋值语句左边的指针类型，但在编码中，习惯在<code>malloc()</code>赋值前做一次强制转换。<br>另外，由于可能在执行内存分配时刚好内存不足，函数也会返回一个<code>NULL</code>，所以对所返回的指针做非空判断。如下所示：</p>
<pre><code>char* p = (char*)malloc(10 * sizeof(char));
if (p == NULL) {
     // handle null error
} else {
     // go on
}</code></pre><ul>
<li>void *calloc(size_t nmemb, size_t size);</li>
</ul>
<p><code>calloc()</code>解决了<code>malloc()</code>分配的内存块无初始化的问题，每个字节都被强制赋值为<code>\0</code>。还有另一个特点是把内存块分配为给定了大小的数组。即第一个参数<code>nmemb</code>指定了分配的元素个数，第二个参数<code>size</code>指定了单个元素的指定大小。<br>刚才<code>malloc()</code>的示例代码可以使用<code>calloc()</code>的话则可修改为：</p>
<pre><code>char* p = (char*)calloc(10, sizeof(char));
if (p == NULL) {
     // handle null error
} else {
     // go on
}</code></pre><ul>
<li>void *realloc(void *ptr, size_t size)</li>
</ul>
<p>在程序运行中，碰到新的数据需要继续填充处理时发现原来的内存块已经不够了，则要开辟新更大的内存块以处理更多的数据，则就需要使用到<code>realloc()</code>函数了。<br><code>realloc()</code>函数的第一个参数<code>ptr</code>表示指向老的内存块的指针，第二个参数<code>sizt</code>则表示新的内存块大小。<br>开辟出新的内存块后，会把老内存块的数据复制到新内存块中；老内存块的空间会自动被系统回收。<br>所以如果新开辟的内存块比较老的内存块大，则前部分是老内存块的数据，后半部分则是未初始化的数据，即内容具有不确定性；如果新开辟的内存块比老的内存块小，则相当于复制了老内存块前半部分的内存到新的内存块中去了；<br>函数正常执行时，返回新内存块的首地址指针；如果函数执行失败，则返回<code>NULL</code>。<br>如果指定的<code>ptr</code>是<code>NULL</code>，则函数的作用相当于<code>malloc(size)</code>;<br>如果指定的<code>size</code>值为0，则相当于调用了<code>free(ptr)</code>去释放了原有的内存块；</p>
<ul>
<li>void free(void *ptr)</li>
</ul>
<p>释放指针<code>ptr</code>所指向的内存块。如果<code>ptr</code>是<code>NULL</code>，则相当于什么也没做。<br>当对<code>ptr</code>执行<code>free()</code>操作后，要及时对<code>ptr</code>赋值为空，避免野指针的出现或误操作。</p>
<hr>
<h1 id="realloc的内存泄露陷井"><a href="#realloc的内存泄露陷井" class="headerlink" title="realloc的内存泄露陷井"></a><a name="mem_leak">realloc的内存泄露陷井</a></h1><p>说是内存泄露陷井，其实是想说一个编码不规范的现象。挺多人在使用<code>realloc()</code>是这么写的：</p>
<pre><code>char * p = (char *)malloc(10 * size(char));
... ...
// 发现内存不够用了
p = realloc(p, 20 * size(char));</code></pre><p>这样子的代码，如果<code>realloc()</code>因某种原因执行失败导致返回<code>NULL</code>对<code>p</code>赋值，则失去了指向原先分配的<code>10 * size(char)</code>这个老内存块的指针，该老内存块再也无法通过<code>free()</code>函数释放了，导致内存泄露。<br>正确的写法应该是这样子的：</p>
<pre><code>char * p = (char *)malloc(10 * size(char));
... ...
// 发现内存不够用了
char * tmp = realloc(p, 20 * size(char));
if (tmp == NULL) {
  // realloc() do failed. do some action
  return; // 这里选择return,也可以再尝试realloc一次或其它
} else {
    p = tmp;
}
// go on do something...</code></pre><hr>
<h1 id="示例代码"><a href="#示例代码" class="headerlink" title="示例代码"></a><a name="demo">示例代码</a></h1><p>以下代码演示从命令行终端中不断获取输入字符的过程。<br>由于一开始内存分配仅分配够存储两个字符，当执行操作时就会出现空间不足需要调用<code>realloc()</code>再开辟更大的空间。</p>
<p>其中示例代码中的函数<code>get_string()</code>见sodino另一篇文章<a href="http://sodino.com/2015/03/04/c-replace-gets/">【C/C++】使用getchar()实现gets()功能</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//  Created by sodino on 15-3-13.</span></span><br><span class="line"><span class="comment">//  Copyright (c) 2015年 sodino. All rights reserved.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> main<span class="comment">/*04*/</span> (<span class="keyword">int</span> argc, <span class="keyword">char</span> ** argv) &#123;</span><br><span class="line">    <span class="keyword">long</span> cache = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">long</span> max_content = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">long</span> max_memory = max_content + <span class="number">1</span>; <span class="comment">// 最后一个位置留给字符串终止符</span></span><br><span class="line">    <span class="keyword">char</span> * pStore = <span class="built_in">calloc</span>(max_memory, <span class="keyword">sizeof</span>(<span class="keyword">char</span>));</span><br><span class="line">    <span class="keyword">if</span> (pStore == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"calloc() failed.\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> EXIT_FAILURE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">long</span> lenStore = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">long</span> remain = max_content;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"input char or input 'exit' to exit: \n"</span>);</span><br><span class="line">        <span class="comment">// 从命令行终端获取输入的字符，每次最多获取10个字符</span></span><br><span class="line">        <span class="keyword">char</span> * pChar = get_string(<span class="number">10</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strcmp</span>(pChar, <span class="string">"exit"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> t_len = <span class="built_in">strlen</span>(pChar);</span><br><span class="line">        <span class="keyword">if</span> (t_len &gt; remain) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"not enough memory. \n"</span>);</span><br><span class="line">            <span class="keyword">long</span> increase = t_len - remain;</span><br><span class="line">            max_memory = max_memory + increase + cache;</span><br><span class="line">            <span class="keyword">char</span> * pClone = pStore;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 开辟更大的内存块...</span></span><br><span class="line">            pClone = <span class="built_in">realloc</span>(pClone, max_memory * <span class="keyword">sizeof</span>(<span class="keyword">char</span>));</span><br><span class="line">            <span class="keyword">if</span> (pClone == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                <span class="comment">//</span></span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"OOM, break; pStore=%s \n"</span>, pStore);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 开拓内存成功</span></span><br><span class="line">                pStore = pClone;</span><br><span class="line">                remain = remain + increase + cache;</span><br><span class="line">                max_content = max_memory - <span class="number">1</span>;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"realloc(), new memory size=%lu max=%lu remain=%lu go to append string.\n"</span>, max_memory * <span class="keyword">sizeof</span>(<span class="keyword">char</span>), max_content, remain);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            strlcat(pStore, pChar, max_memory);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">strlen</span>(pStore) == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">strcat</span>(pStore, pChar);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                strlcat(pStore, pChar, max_memory);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        lenStore = <span class="built_in">strlen</span>(pStore);</span><br><span class="line">        remain = max_content - lenStore;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"lenStore=%lu max=%lu remain=%lu content:%s \n"</span>, lenStore, max_content, remain, pStore);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"end."</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 程序终止后释放内存</span></span><br><span class="line">    <span class="built_in">free</span>(pStore);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 保持习惯，及时置空</span></span><br><span class="line">    pStore = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> EXIT_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行效果如下图：<br><img src="http://ww2.sinaimg.cn/mw1024/e3dc9ceagw1eqieitkafgj20e006tgno.jpg" alt="memory_allocation_demo"></p>
</div><div class="tags"><a href="/tags/C-C/">C/C++</a></div><div class="post-nav"><a class="pre" href="/2015/03/26/c-union/">【C/C++】共用体Union</a><a class="next" href="/2015/03/20/c-time-micro-nano/">【C/C++】时间精确到微秒、纳秒</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"><input type="hidden" name="sitesearch" value="http://sodino.com"></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/android/">Android</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/AndroidStudio/">AndroidStudio</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/C-C/">C/C++</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Eclipse/">Eclipse</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Hexo/">Hexo</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/JDK/">JDK</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/JNI/">JNI</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/JavaScript/">JavaScript</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/LBS/">LBS</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Mac/">Mac</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Node-js/">Node.js</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Proguard/">Proguard</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/React-Native/">React-Native</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/blog/">blog</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/blog/" style="font-size: 15px;">blog</a> <a href="/tags/Android/" style="font-size: 15px;">Android</a> <a href="/tags/AndroidStudio/" style="font-size: 15px;">AndroidStudio</a> <a href="/tags/C-C/" style="font-size: 15px;">C/C++</a> <a href="/tags/Eclipse/" style="font-size: 15px;">Eclipse</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/object-Object/" style="font-size: 15px;">[object Object]</a> <a href="/tags/NDK/" style="font-size: 15px;">NDK</a> <a href="/tags/Hexo/" style="font-size: 15px;">Hexo</a> <a href="/tags/markdown/" style="font-size: 15px;">markdown</a> <a href="/tags/JNI/" style="font-size: 15px;">JNI</a> <a href="/tags/JavaScript/" style="font-size: 15px;">JavaScript</a> <a href="/tags/Node-js/" style="font-size: 15px;">Node.js</a> <a href="/tags/Mac/" style="font-size: 15px;">Mac</a> <a href="/tags/LBS/" style="font-size: 15px;">LBS</a> <a href="/tags/JDK/" style="font-size: 15px;">JDK</a> <a href="/tags/Proguard/" style="font-size: 15px;">Proguard</a> <a href="/tags/Java/" style="font-size: 15px;">Java</a> <a href="/tags/React-Native/" style="font-size: 15px;">React-Native</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/04/01/react-native-provide-custom-config-4-fresco/">【Android】React-Native为Fresco的初始化提供自定义的Configuration</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/02/22/dexcount/">【Android】方法数查看工具---DexCount</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/02/22/retrofit-notes/">【Android】Retrofit 的一些笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/01/20/android-transparent-statusbar/">【Android】透明状态栏在App中的实现与接口设计</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/12/28/android-ripple/">【Android】Ripple使用总结及ClickableSpan的冲突解决</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/12/14/react-native-es6-Solidot/">【React-Native】开源的入门项目 Solidot</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/01/android-mediaPlayer-2-bugs/">【Android】记录Android MediaPlayer的两个bug及其它特殊表现</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/01/android-gradle-change-appName/">【Android】Gadle改变应用名称(appName)的两种方法</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/01/mongo-background-service/">【Linux】启动mongo db后台服务</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/08/30/yum-uninstall-mongodb/">【Linux】yum卸载mongodb及后续问题的解决</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://blog.csdn.net/sodino" title="CSDN's blog" target="_blank">CSDN's blog</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2020 <a href="/." rel="nofollow">Sodino's Blog.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.2.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.2.5/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>