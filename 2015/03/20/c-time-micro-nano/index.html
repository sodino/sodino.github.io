<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="Sodino的个人博客"><title>【C/C++】时间精确到微秒、纳秒 | Sodino's Blog</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/7.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">【C/C++】时间精确到微秒、纳秒</h1><a id="logo" href="/.">Sodino's Blog</a><p class="description">见多食广 与食巨近</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> RSS</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">【C/C++】时间精确到微秒、纳秒</h1><div class="post-meta">Mar 20, 2015<span> | </span><span class="category"><a href="/categories/C-C/">C/C++</a></span></div><div class="post-content"><p>在之前的文章<a href="http://sodino.com/2015/03/15/c-time/">【C/C++】日常时间的获取、格式化等操作汇总</a>中讲到的时间都是以秒为精度的。有时候需要确定某个事件的准确时间，就得把精度提高到毫秒(millsecond)、微秒(microsecond)、纳秒(nanosecond,很少用)。这里将讲解并演示如何使用。</p>
<p>C语言中所支持的精度在秒之下有微秒和纳秒，所以需要精度为毫秒的话建议直接使用微秒这个更高精度的时间值。</p>
<p>文章结构：</p>
<ul>
<li><a href="#time_struct">高精度时间结构体</a></li>
<li><a href="#time_func">时间函数</a></li>
<li><a href="#time_subtract">宏:计算时间差</a></li>
<li><a href="#time_demo">示例代码</a></li>
</ul>
<hr>
<h1 id="高精度时间结构体"><a href="#高精度时间结构体" class="headerlink" title="高精度时间结构体"></a><a name="time_struct">高精度时间结构体</a></h1><ul>
<li>微秒 <pre><code>#include &lt;sys/time.h&gt;
struct timeval {
    time_t      tv_sec;     /* seconds */
    suseconds_t tv_usec;    /* microseconds */
};
</code></pre>在结构体中，<code>tv_sec</code>表示当时时刻的秒数，和之前文章提到的日常时间或时间绝对值是等价的。<code>tv_usec</code>则是微秒值。即1000000微秒为1秒，所以其取值范围为[0, 1000000)。<br>由于<code>tv_sec</code>的<code>time_t</code>的结构体，所以很容易获取当前时间的详情或格式化成时间文本。见之前的文章<a href="http://sodino.com/2015/03/15/c-time/">【C/C++】日常时间的获取、格式化等操作汇总</a>。</li>
</ul>
<ul>
<li>纳秒<pre><code>#include &lt;time.h&gt;
struct timespec {
    time_t   tv_sec;        /* seconds */
    long     tv_nsec;       /* nanoseconds */
};
</code></pre></li>
</ul>
<p>在结构体中，<code>tv_sec</code>也表示当时时刻的秒数。<code>tv_nsec</code>则是纳秒值。即10亿纳秒为1秒，所以其取值范围为[0, 10^12)。</p>
<hr>
<h1 id="时间函数"><a href="#时间函数" class="headerlink" title="时间函数"></a><a name="time_func">时间函数</a></h1><ul>
<li>获取微秒：<blockquote>
<p>int gettimeofday(struct timeval *tv, struct timezone *tz);</p>
</blockquote>
</li>
</ul>
<p>执行本函数后，所获取的时间值将会被存储在第一个参数<code>tv</code>中，第二参数<code>tz</code>在Linux中已经不被使用了(自己搜索<code>夏令时</code>)，所以直接传<code>NULL</code>。<br>函数正常执行后将会返回0，否则返回-1并可通过errno来查看失败原因。<br>如果系统管理员修改了机器的时间(调整日期)，则本函数所获取的时间也会随之发生变化。</p>
<ul>
<li>获取纳秒：<br>获取纳秒的步骤比较麻烦，需要提前获取进程id，和<code>clock_id</code>。</li>
</ul>
<p>获取进程id的函数如下：</p>
<p><code>#include &lt;unistd.h&gt;</code></p>
<blockquote>
<p>pid_t getpid(void);<br>pid_t getppid(void);</p>
</blockquote>
<p><code>getpid()</code>返回当前进程的进程id，<code>getppid()</code>返回当前进程的父进程的进程id。</p>
<p><code>#include &lt;time.h&gt;</code></p>
<blockquote>
<p>int clock_getcpuclockid(pid_t pid, clockid_t *clock_id);</p>
</blockquote>
<p>获取指定进程的<code>clock_id</code>。如果参数<code>pid</code>赋值为0，则获取的是当前函数执行的进程的<code>clock_id</code>。<br>当函数正常执行时返回0，且<code>clock_id</code>会被正确赋值；出错时则返回<code>ENOSYS</code>(内核版本不支持)、<code>EPERM</code>(权限不够)、<code>ESRCH</code>(找不到id值为pid的进程)。</p>
<p><code>#include &lt;time.h&gt;</code></p>
<blockquote>
<p>int clock_gettime(clockid_t clk_id, struct timespec *tp);</p>
</blockquote>
<p>这才是最后的最后，获取纳秒。<br>与<code>gettimeofday()</code>不同的是<code>clock_gettime()</code>是获取进程的时间所经过的时间，所以不随系统管理员修改机器时间而改变。<br>一般用不到纳秒，本文章不预继续讨论了。(我会跟你说其实是我懒得写了！ （逃…    )</p>
<hr>
<h1 id="宏-计算时间差"><a href="#宏-计算时间差" class="headerlink" title="宏:计算时间差"></a><a name="time_subtract">宏:计算时间差</a></h1><p>获取到微秒的时间后，由于时间被分开成了两个值来表示，所以时间差的计算并不能直接相减。<br>查看<code>time.h</code>发现已经有一些现成长定义好的宏可以用来计算时间差<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">#define	timersub(tvp, uvp, vvp)						\</div><div class="line">	do &#123;								\</div><div class="line">		(vvp)-&gt;tv_sec = (tvp)-&gt;tv_sec - (uvp)-&gt;tv_sec;		\</div><div class="line">		(vvp)-&gt;tv_usec = (tvp)-&gt;tv_usec - (uvp)-&gt;tv_usec;	\</div><div class="line">		if ((vvp)-&gt;tv_usec &lt; 0) &#123;				\</div><div class="line">			(vvp)-&gt;tv_sec--;				\</div><div class="line">			(vvp)-&gt;tv_usec += 1000000;			\</div><div class="line">		&#125;							\</div><div class="line">	&#125; while (0)</div></pre></td></tr></table></figure></p>
<p>被减数<code>tvp</code> 减去 <code>uvp</code>的结果存储于<code>vvp</code>中。<br>还有一些其它的宏，如：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">timerclear  // 清除时间</div><div class="line">timerisset  // 结构体中是否有设置时间值</div><div class="line">timercmp    // 比较时间值大小</div><div class="line">timeradd    // 两个时间值相加</div></pre></td></tr></table></figure></p>
<hr>
<h1 id="示例代码"><a href="#示例代码" class="headerlink" title="示例代码"></a><a name="time_demo">示例代码</a></h1><p>以下代码演示获取微秒时间 ，并转换为日常时间的格式化字符串，最后求得本段代码在运行时的总耗时。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">struct timeval t_val;</div><div class="line">gettimeofday(&amp;t_val, NULL);</div><div class="line">printf(&quot;start, now, sec=%ld m_sec=%d \n&quot;, t_val.tv_sec, t_val.tv_usec);</div><div class="line"></div><div class="line">long sec = t_val.tv_sec;</div><div class="line">time_t t_sec = (time_t)sec;</div><div class="line">printf(&quot;date:%s&quot;, ctime(&amp;t_sec));</div><div class="line"></div><div class="line">struct timeval t_val_end;</div><div class="line">gettimeofday(&amp;t_val_end, NULL);</div><div class="line"></div><div class="line">struct timeval t_result;</div><div class="line">timersub(&amp;t_val_end, &amp;t_val, &amp;t_result);</div><div class="line"></div><div class="line">double consume = t_result.tv_sec + (1.0 * t_result.tv_usec)/1000000;</div><div class="line">printf(&quot;end.elapsed time= %fs \n&quot;, consume);</div></pre></td></tr></table></figure></p>
<p>运行结果：</p>
<p><img src="http://ww2.sinaimg.cn/mw1024/e3dc9ceagw1eqckzjamo4j209202mwet.jpg" alt="time.micro.demo"></p>
</div><div class="tags"><a href="/tags/C-C/">C/C++</a></div><div class="post-nav"><a class="pre" href="/2015/03/22/c-memory-allocation/">【C/C++】内存分配与释放(malloc、calloc、realloc、free)</a><a class="next" href="/2015/03/19/linux-cpu-and-processor-time/">【Linux】CPU时间与处理器耗时</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://sodino.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/android/">Android</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/AndroidStudio/">AndroidStudio</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/C-C/">C/C++</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Eclipse/">Eclipse</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Hexo/">Hexo</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/JDK/">JDK</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/JNI/">JNI</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/JavaScript/">JavaScript</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/LBS/">LBS</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Mac/">Mac</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Node-js/">Node.js</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Proguard/">Proguard</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/React-Native/">React-Native</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/blog/">blog</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/markdown/" style="font-size: 15px;">markdown</a> <a href="/tags/blog/" style="font-size: 15px;">blog</a> <a href="/tags/AndroidStudio/" style="font-size: 15px;">AndroidStudio</a> <a href="/tags/Eclipse/" style="font-size: 15px;">Eclipse</a> <a href="/tags/C-C/" style="font-size: 15px;">C/C++</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/object-Object/" style="font-size: 15px;">[object Object]</a> <a href="/tags/NDK/" style="font-size: 15px;">NDK</a> <a href="/tags/Hexo/" style="font-size: 15px;">Hexo</a> <a href="/tags/Android/" style="font-size: 15px;">Android</a> <a href="/tags/JNI/" style="font-size: 15px;">JNI</a> <a href="/tags/JavaScript/" style="font-size: 15px;">JavaScript</a> <a href="/tags/Node-js/" style="font-size: 15px;">Node.js</a> <a href="/tags/LBS/" style="font-size: 15px;">LBS</a> <a href="/tags/JDK/" style="font-size: 15px;">JDK</a> <a href="/tags/Mac/" style="font-size: 15px;">Mac</a> <a href="/tags/Java/" style="font-size: 15px;">Java</a> <a href="/tags/Proguard/" style="font-size: 15px;">Proguard</a> <a href="/tags/React-Native/" style="font-size: 15px;">React-Native</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/04/01/react-native-provide-custom-config-4-fresco/">【Android】React-Native为Fresco的初始化提供自定义的Configuration</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/02/22/dexcount/">【Android】方法数查看工具---DexCount</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/02/22/retrofit-notes/">【Android】Retrofit 的一些笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/01/20/android-transparent-statusbar/">【Android】透明状态栏在App中的实现与接口设计</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/12/28/android-ripple/">【Android】Ripple使用总结及ClickableSpan的冲突解决</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/12/14/react-native-es6-Solidot/">【React-Native】开源的入门项目 Solidot</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/01/android-mediaPlayer-2-bugs/">【Android】记录Android MediaPlayer的两个bug及其它特殊表现</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/01/android-gradle-change-appName/">【Android】Gadle改变应用名称(appName)的两种方法</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/01/mongo-background-service/">【Linux】启动mongo db后台服务</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/08/30/yum-uninstall-mongodb/">【Linux】yum卸载mongodb及后续问题的解决</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://blog.csdn.net/sodino" title="CSDN's blog" target="_blank">CSDN's blog</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2018 <a href="/." rel="nofollow">Sodino's Blog.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.2.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.2.5/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>