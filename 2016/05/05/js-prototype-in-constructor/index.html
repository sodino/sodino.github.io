<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="Sodino的个人博客"><title>【JavaScript】构造函数中定义prototype的异常现象及研究 | Sodino's Blog</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/7.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">【JavaScript】构造函数中定义prototype的异常现象及研究</h1><a id="logo" href="/.">Sodino's Blog</a><p class="description">见多食广 与食巨近</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> RSS</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">【JavaScript】构造函数中定义prototype的异常现象及研究</h1><div class="post-meta">May 5, 2016<span> | </span><span class="category"><a href="/categories/JavaScript/">JavaScript</a></span></div><div class="post-content"><p>文章结构</p>
<ul>
<li><a href="#normal_prototype">prototype正常的定义方式</a></li>
<li><a href="#exception">构造函数中定义prototype的异常现象</a></li>
<li><a href="#instanceof">(benz instanceof Car) 为false 问题</a></li>
<li><a href="#is_not_function">benz.printHistory is not a function 问题</a></li>
<li><a href="#summary">总结</a></li>
<li><a href="#test">练习</a></li>
</ul>
<hr>
<h1 id="prototype正常的定义方式"><a href="#prototype正常的定义方式" class="headerlink" title="prototype正常的定义方式"></a><a name="normal_prototype">prototype正常的定义方式</a></h1><p>JavaScript一般构造函数与prototype的定义是分离的，正常的实现方式如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">代码一：</div><div class="line">function Car() &#123;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">Car.prototype = &#123;</div><div class="line">    printHistory : function()&#123;</div><div class="line">        console.log(&apos;print history...&apos;);</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">var benz = new Car();</div><div class="line">benz.printHistory();</div></pre></td></tr></table></figure>
<p>以上代码正常输出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">D:\desk\JavaScript&gt;node prototype.js</div><div class="line">print history...</div></pre></td></tr></table></figure>
<hr>
<h1 id="构造函数中定义prototype的异常现象"><a href="#构造函数中定义prototype的异常现象" class="headerlink" title="构造函数中定义prototype的异常现象"></a><a name="exception">构造函数中定义prototype的异常现象</a></h1><p>但如果在构造函数中定义prototype，如下代码二所示，则会出现意外的情况：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">代码二：</div><div class="line">function Car() &#123;</div><div class="line">    // 在构造函数中定义prototype // sodino.com</div><div class="line">    Car.prototype = &#123;                     //  第3行</div><div class="line">        printHistory : function()&#123;</div><div class="line">            console.log(&apos;print history...&apos;);</div><div class="line">        &#125;</div><div class="line">    &#125;;    </div><div class="line">&#125;;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">var benz = new Car();   </div><div class="line">var bmw = new Car();</div><div class="line"></div><div class="line">console.log(&apos;benz instanceof Car : &apos;+ (benz instanceof Car));</div><div class="line">console.log(&apos;bmw instanceof Car : &apos;+ (bmw instanceof Car));</div><div class="line"></div><div class="line">bmw.printHistory();</div><div class="line">benz.printHistory();</div></pre></td></tr></table></figure>
<p>运行如上代码，会发生如下异常：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">D:\desk\JavaScript&gt;node prototype.01.js</div><div class="line">benz instanceof Car : false</div><div class="line">bmw instanceof Car : false       // benz和bmw都不是Car的子类..诧异!</div><div class="line">print history...                 // bmw能正常打印 print History...</div><div class="line">D:\desk\JavaScript\prototype.01.js:18   // 但benz却打印失败了...</div><div class="line">benz.printHistory();</div><div class="line">     ^</div><div class="line"></div><div class="line">TypeError: benz.printHistory is not a function</div><div class="line">    at Object.&lt;anonymous&gt; (D:\desk\JavaScript\prototype.01.js:18:6)</div><div class="line">    at Module._compile (module.js:413:34)</div><div class="line">    at Object.Module._extensions..js (module.js:422:10)</div><div class="line">    at Module.load (module.js:357:32)</div><div class="line">    at Function.Module._load (module.js:314:12)</div><div class="line">    at Function.Module.runMain (module.js:447:10)</div><div class="line">    at startup (node.js:141:18)</div><div class="line">    at node.js:933:3</div></pre></td></tr></table></figure>
<p>由上控制台打印可见异常现象有两处：</p>
<ul>
<li>为什么benz和bmw都不是Car的子类？</li>
<li>为什么benz.printHistory() is not a function??</li>
</ul>
<hr>
<h1 id="benz-instanceof-Car-为false-问题"><a href="#benz-instanceof-Car-为false-问题" class="headerlink" title="(benz instanceof Car) 为false 问题"></a><a name="instanceof">(benz instanceof Car) 为false 问题</a></h1><p>先来解决为什么benz和bmw不是Car子类的问题吧。</p>
<p>需要先了解 <code>instanceof</code> 关键字的工作原理，当调用 <code>benz instanceof Car</code> 时，解释器是判断<code>benz.__proto__</code>是否为<code>Car.prototype</code>属性所指向的对象。<br>在代码一中，两者的关系如下图，是相同的。<br><img src="http://ww4.sinaimg.cn/mw1024/e3dc9ceagw1f3kukc6cpaj20j9093tal.jpg" alt="proto"></p>
<p>也就是说如果<code>benz.__proto__ == Car.prototype</code>就认为benz是Car的对象，当然在判断时并不是只判断benz的原型，而是判断benz的原型链中的每个对象，例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">var str = new String(&apos;abc&apos;);</div><div class="line">str instanceof String;         // true</div><div class="line">str instanceof Object;        // true</div></pre></td></tr></table></figure>
<p>上面的两条语句都会返回true，因为str的原型链中包含这两个对象。</p>
<p>既然<code>benz instanceof Car</code> 值为false，即表明<code>benz.__proto__</code>与<code>Car.prototype</code>不相等，或者说是<code>Car.prototype</code>的值前后发生了变化。<br>看代码，很明显发现未执行new操作前，与执行new操作后，<code>Car.prototype</code>在代码二的第3行处被重新赋值给了一个新对象。<br>而且构造函数每执行一次，<code>Car.prototype</code>都会被重新赋值一次，虽然赋值的对象是完全相同的结构。<br>但解释器判断两个对象是否相等的条件为两个对象是否引用同一个地址块。<br>通过以下代码三可以判断构造函数被执行后，<code>Car.prototype</code>的值每次都被改变了..</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">代码三：</div><div class="line">var last;</div><div class="line"></div><div class="line">function Car() &#123;</div><div class="line">    last = Car.prototype;</div><div class="line">    Car.prototype = &#123;</div><div class="line">        printHistory : function()&#123;</div><div class="line">            console.log(&apos;print history...&apos;);</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    var changed = (last != Car.prototype);    // 每次都是 true</div><div class="line">    console.log(&apos;Car.prototype changed : &apos;, changed);    </div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>所以benz的原型链中已经与运行后的<code>Car.prototype</code>没有任何关系了，自然<code>benz instanceof Car</code>值为false。</p>
<hr>
<h1 id="benz-printHistory-is-not-a-function-问题"><a href="#benz-printHistory-is-not-a-function-问题" class="headerlink" title="benz.printHistory is not a function 问题"></a><a name="is_not_function">benz.printHistory is not a function 问题</a></h1><p>benz是最先执行Car构造函数的，然后是bmw，但bmw.printHistory()正常执行，说明benz的类方法中并未声明printHistory()函数。<br>原因是解释器的构造对象时，是先将最开始的<code>Car.prototype</code>设置为benz的原型，然后再执行构造函数，而构造函数中对<code>Car.prototype</code>的篡改并不会反映到benz的原型中去。<br>所以benz的原型是个名为Car的空函数而已。<br>而bmw在初始化时，<code>Car.prototype</code>已经被赋值为一个新的匿名的Object对象，并带有printHistory()的函数声明，所以bmw.printHistory()可以正常执行。<br>两者的区别如下图所示：<br><img src="http://ww3.sinaimg.cn/mw1024/e3dc9ceagw1f3kukcsjqnj20j9046gmc.jpg" alt="difference"></p>
<hr>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a><a name="summary">总结</a></h1><p>在构造函数中对prototype重新定义是一个非常严重的错误。</p>
<hr>
<h1 id="练习"><a href="#练习" class="headerlink" title="练习"></a><a name="test">练习</a></h1><p>代码一连同以下两种方式，都能正常执行printHistory()方法，但这三种实现方式各有什么区别呢？</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">代码四:</div><div class="line">function Car() &#123;</div><div class="line">    this.printHistory = function() &#123;</div><div class="line">        console.log(&apos;print history...&apos;);</div><div class="line">    &#125;;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">var benz = new Car();</div><div class="line">benz.printHistory();</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">代码五：</div><div class="line">var Car = (function()&#123;</div><div class="line">    function Car1() &#123;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    Car1.prototype = &#123;</div><div class="line">        printHistory : function () &#123;</div><div class="line">            console.log(&apos;print history..&apos;);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    return Car1;</div><div class="line">&#125;());</div><div class="line"></div><div class="line">var benz = new Car();</div><div class="line">benz.printHistory();</div></pre></td></tr></table></figure>
<p>代码一和代码五的功能及效果是一致的，没有区别；只是代码五的实现方式在代码结构上更加紧凑，易于维护。<br>代码四的区别在于printHistory()并不具备可继承性，因为this.printHistory()指定了该方法为Car私有。<br>参考链接<a href="http://sodino.com/2016/05/10/js-extend-true-and-false/#strict_extend">更严格的继承</a>。</p>
<hr>
<p><a href="http://sodino.com/about/">About Sodino</a></p>
</div><div class="tags"><a href="/tags/JavaScript/">JavaScript</a></div><div class="post-nav"><a class="pre" href="/2016/05/10/js-extend-true-and-false/">【JavaScript】继承的真真假假</a><a class="next" href="/2016/05/04/js-this/">【JavaScript】'this'详解</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://sodino.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/android/">Android</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/AndroidStudio/">AndroidStudio</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/C-C/">C/C++</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Eclipse/">Eclipse</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Hexo/">Hexo</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/JDK/">JDK</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/JNI/">JNI</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/JavaScript/">JavaScript</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/LBS/">LBS</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Mac/">Mac</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Node-js/">Node.js</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Proguard/">Proguard</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/React-Native/">React-Native</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/blog/">blog</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/markdown/" style="font-size: 15px;">markdown</a> <a href="/tags/blog/" style="font-size: 15px;">blog</a> <a href="/tags/AndroidStudio/" style="font-size: 15px;">AndroidStudio</a> <a href="/tags/Eclipse/" style="font-size: 15px;">Eclipse</a> <a href="/tags/C-C/" style="font-size: 15px;">C/C++</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/object-Object/" style="font-size: 15px;">[object Object]</a> <a href="/tags/NDK/" style="font-size: 15px;">NDK</a> <a href="/tags/Hexo/" style="font-size: 15px;">Hexo</a> <a href="/tags/Android/" style="font-size: 15px;">Android</a> <a href="/tags/JNI/" style="font-size: 15px;">JNI</a> <a href="/tags/JavaScript/" style="font-size: 15px;">JavaScript</a> <a href="/tags/Node-js/" style="font-size: 15px;">Node.js</a> <a href="/tags/LBS/" style="font-size: 15px;">LBS</a> <a href="/tags/JDK/" style="font-size: 15px;">JDK</a> <a href="/tags/Mac/" style="font-size: 15px;">Mac</a> <a href="/tags/Java/" style="font-size: 15px;">Java</a> <a href="/tags/Proguard/" style="font-size: 15px;">Proguard</a> <a href="/tags/React-Native/" style="font-size: 15px;">React-Native</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/04/01/react-native-provide-custom-config-4-fresco/">【Android】React-Native为Fresco的初始化提供自定义的Configuration</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/02/22/dexcount/">【Android】方法数查看工具---DexCount</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/02/22/retrofit-notes/">【Android】Retrofit 的一些笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/01/20/android-transparent-statusbar/">【Android】透明状态栏在App中的实现与接口设计</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/12/28/android-ripple/">【Android】Ripple使用总结及ClickableSpan的冲突解决</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/12/14/react-native-es6-Solidot/">【React-Native】开源的入门项目 Solidot</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/01/android-mediaPlayer-2-bugs/">【Android】记录Android MediaPlayer的两个bug及其它特殊表现</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/01/android-gradle-change-appName/">【Android】Gadle改变应用名称(appName)的两种方法</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/01/mongo-background-service/">【Linux】启动mongo db后台服务</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/08/30/yum-uninstall-mongodb/">【Linux】yum卸载mongodb及后续问题的解决</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://blog.csdn.net/sodino" title="CSDN's blog" target="_blank">CSDN's blog</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2018 <a href="/." rel="nofollow">Sodino's Blog.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.2.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.2.5/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>